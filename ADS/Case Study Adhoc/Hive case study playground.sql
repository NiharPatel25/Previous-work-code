select * from user_groupondw.m_raw_dealview where eventdate = '2022-03-07' and bcookie = '7178083F-BCB6-D8B1-919B-9D41C8625973';



('abe208b0-f79a-4ffc-b00a-c7ab3174531e', 'bc742c06-5082-41c9-9a1a-df57bd2e61d7', '01f70000-0bb9-4318-bbe4-79dd8a4c8d4f', 'b4ee1d59-8cc7-471f-9b8d-5e416e80eb4f',
                    '3fda84f3-f402-4bc1-ba45-4f945c286275', '1a226f06-1179-4e53-97ce-afd7b4fd29b1', '8aed4d2f-a7e6-4da0-9d10-2d6382684f6c', '02a76145-b2fd-457e-a3f7-4442af48e7a6',
                    '2ed9df69-c9dc-4f11-a832-784de84c9706', 'd444611b-6b9e-4bf6-811b-e704ce925179', '1c94819b-6c7e-4af5-b454-096cc9b5cfeb', 'cd0066d9-629d-49cb-be27-cc7555a74a9f', 
                    'eae26db7-5923-4835-8ca8-8e50e2dd3bbe','e3fd2c89-2371-4258-8e3d-708293bb81b5', '15cdcd5d-31c5-417a-9f42-95add368880c', 'ef45d110-8902-499d-8cca-987cef9009d2', 
                    'e7e35bf8-9fe3-4598-b322-4ad1e1a14c3a', 'bac147aa-b151-41cd-b834-3b1b759fb667', 'dcf354d7-9602-40e9-bc76-66f5cc7dc665', '1e827ff1-5c1b-40d9-9f83-6c351d1d0874',
                    '3fa6b0d9-acd2-4c74-be9c-98d8e3515199', '6de3a148-11fe-4df1-a139-db5ad4a13764', 'cea19a48-754e-4e5c-868b-bad28a4a46ca',
                    '30d3b8ad-967c-4e8e-89b3-2f9d1ac04b26', 'ef8ccdfa-39a3-4038-a9f0-880dab993af1', 'd10d63d6-9602-4e3f-acd3-06d963d4b5e2', 'a42e3961-0a36-43cf-853b-fe86fd0cc68f',
                    'f09a2d2b-2820-4517-b19c-78e9f3cc26b4', 'a5f1942f-0c11-4785-93b8-e17a07baa831', '0ed03101-234d-4ad2-a2e7-d2c2b4595b9c', '9bce4f37-e274-48bc-8152-27e898ee4f24',
                    'bd876c5b-8be7-4f02-9a42-5e582aaa6ed0', '981fe8e0-145b-47d2-8919-8854132ac364', '2212684f-b331-44ca-8d18-fe524077ffd3', 'b5e20da9-21d5-40ff-b9b5-75a48de41b94',
                    'f5d6101b-5098-493e-af6f-a072f1951aa5', 'a85886ce-b722-4964-94d0-5f525d4b2b83', 'a1ac3718-0b56-47a1-a527-89256f4284e0', '1270f9a5-f249-4ff3-9a93-ed9c59be7bbf',
                    'e864e6f6-586c-4cf4-b90b-d8b4d63a348b', 'd7cd3ea3-398f-450a-ab55-779de378af08', 'b46e39ed-497b-4643-b7f4-d9886c7a6cec', '53196fcf-733a-46ca-af62-b5b21e67de6a',
                    '9d6c7545-c25f-4820-b0ba-437cf5bd4f91','fd81cba1-f10d-4f8b-a819-287ef51c8f71', 'dff1203f-7d63-401c-8d63-dc6be6d1a07b', '2469e230-17e7-4249-9b83-6528afbe56bf',
                    '63534f46-af03-4690-85e8-57d94f839c4a', '83fbd23e-2323-441a-9af7-509ad6f067ef', '0e1f623a-0a49-4315-8f1f-8dc0010288ab', '9a7773e7-0ac0-4e68-bcf1-91174e4b4295',
                    'f703dbec-6d86-44cb-b46b-425c834770f7', 'ccbdb136-f7c6-4d1e-8e9e-ac0efae71c46', 'e1a389ed-4ca4-44b5-980c-928d93c8a48a', '29c494a2-0aec-4e8c-9949-942bdaa86d19',
                    'ac13fb23-a5e3-4143-a3c9-4412ecdd3d63', '9f37930f-6e42-4f8a-ac4b-cbdd36e2807d', 'd66a5919-e4cb-4848-a92e-9881d125b37d', 'e0f65b40-5526-40da-bece-6a7cef0010cb',
                    '5da912d4-0931-4850-8a0d-c63f7ed6112e', 'ce277d7f-0cb9-477a-8a38-5da882bc1b6f', '327de201-b5cd-40a0-92c8-0d0bf7bca270', '51343d2e-6ead-4f25-8167-92e60a6fd7bc', 
                    '860057fa-5872-45dc-9d69-1a41847f8809', 'b65cd09b-2362-4ca5-b702-2862997dfb8f', '5ace6c43-8c57-4041-bbb0-178081113ae2', '268205d6-2786-4a4c-ad12-4a80fba2f961', 
                    '69d3abb5-f6a2-4339-957c-4670af3b7bc8', '8f32af7b-dd22-4ecd-b760-7840a4323008', '8f618a97-7096-46d6-a1a9-5b5752de7846', '4c3cbeaa-2a30-4895-9d2e-5eff5d9ab889', 
                    '4f3bbd9c-6b87-4e7c-8f45-f14cbffb78fc', 'e5ba88a7-bfb1-4806-96af-15ce969e06aa', 'f12b16bc-5d0d-4e19-8f93-ec74e4430199', '2f63c478-71a1-42b6-bcc3-e285871c54cc',
                    '34acff9d-5ee9-4e8f-aef8-b1cd3cbce2dc', '31512681-06d2-45da-bf06-9ed037c63bce', 'c1fea627-f177-4820-9dbb-7ae6a07dc09d', 'fee28c1b-781c-4089-af12-1e0789f803a8'
                    )

Blue Apron - 
	Blue Apron - COUP - abe208b0-f79a-4ffc-b00a-c7ab3174531e

Fabletics - Definitely Leo - 
	Fabletics - COUP	bc742c06-5082-41c9-9a1a-df57bd2e61d7

First Leaf - Wine - 
	First Leaf - COUP	01f70000-0bb9-4318-bbe4-79dd8a4c8d4f

Winc - Leo - 
	Winc - COUP	b4ee1d59-8cc7-471f-9b8d-5e416e80eb4f

Expedia Group

	Expedia Group - COUP	3fda84f3-f402-4bc1-ba45-4f945c286275
	Expedia Group - COUP	1a226f06-1179-4e53-97ce-afd7b4fd29b1
	Expedia Group - COUP	8aed4d2f-a7e6-4da0-9d10-2d6382684f6c
	Expedia Group - COUP	02a76145-b2fd-457e-a3f7-4442af48e7a6

Avis/Budget

	Avis / Budget - COUP	2ed9df69-c9dc-4f11-a832-784de84c9706
	Avis / Budget - COUP	d444611b-6b9e-4bf6-811b-e704ce925179
	Avis / Budget - COUP	1c94819b-6c7e-4af5-b454-096cc9b5cfeb
	Avis / Budget - COUP	cd0066d9-629d-49cb-be27-cc7555a74a9f
	Avis / Budget - COUP	eae26db7-5923-4835-8ca8-8e50e2dd3bbe
	Avis / Budget - COUP	e3fd2c89-2371-4258-8e3d-708293bb81b5
	Avis / Budget - COUP	15cdcd5d-31c5-417a-9f42-95add368880c
	Avis / Budget - COUP	ef45d110-8902-499d-8cca-987cef9009d2
	Avis / Budget - COUP	e7e35bf8-9fe3-4598-b322-4ad1e1a14c3a
	Avis / Budget - COUP	bac147aa-b151-41cd-b834-3b1b759fb667
	Avis / Budget - COUP	dcf354d7-9602-40e9-bc76-66f5cc7dc665
	
ADT

	ADT - COUP	3fa6b0d9-acd2-4c74-be9c-98d8e3515199
	
	

'HelloFresh

	Hello Fresh - ENT	1e827ff1-5c1b-40d9-9f83-6c351d1d0874'

LaserAway

	LaserAway - ENT	6de3a148-11fe-4df1-a139-db5ad4a13764
	LaserAway - ENT	cea19a48-754e-4e5c-868b-bad28a4a46ca
	LaserAway - ENT	30d3b8ad-967c-4e8e-89b3-2f9d1ac04b26
	LaserAway - ENT	ef8ccdfa-39a3-4038-a9f0-880dab993af1
	LaserAway - ENT	d10d63d6-9602-4e3f-acd3-06d963d4b5e2
	LaserAway - ENT	a42e3961-0a36-43cf-853b-fe86fd0cc68f
	LaserAway - ENT	f09a2d2b-2820-4517-b19c-78e9f3cc26b4
	LaserAway - ENT	a5f1942f-0c11-4785-93b8-e17a07baa831
	LaserAway - ENT	0ed03101-234d-4ad2-a2e7-d2c2b4595b9c
	LaserAway - ENT	9bce4f37-e274-48bc-8152-27e898ee4f24
	LaserAway - ENT	bd876c5b-8be7-4f02-9a42-5e582aaa6ed0
	LaserAway - ENT	981fe8e0-145b-47d2-8919-8854132ac364

Splash Wines

	Splash Wines - ENT	2212684f-b331-44ca-8d18-fe524077ffd3
	Splash Wines - ENT	b5e20da9-21d5-40ff-b9b5-75a48de41b94
	Splash Wines - ENT	f5d6101b-5098-493e-af6f-a072f1951aa5
	Splash Wines - ENT	a85886ce-b722-4964-94d0-5f525d4b2b83
	Splash Wines - ENT	a1ac3718-0b56-47a1-a527-89256f4284e0
	Splash Wines - ENT	1270f9a5-f249-4ff3-9a93-ed9c59be7bbf

SeaWorld

	SeaWorld Orlando - ENT	e864e6f6-586c-4cf4-b90b-d8b4d63a348b
	SeaWorld Orlando - ENT	d7cd3ea3-398f-450a-ab55-779de378af08

RealEstateU

	RealEstateU - ENT	b46e39ed-497b-4643-b7f4-d9886c7a6cec
	RealEstateU - ENT	53196fcf-733a-46ca-af62-b5b21e67de6a
	RealEstateU - ENT	9d6c7545-c25f-4820-b0ba-437cf5bd4f91
	RealEstateU - ENT	fd81cba1-f10d-4f8b-a819-287ef51c8f71
	RealEstateU - ENT	dff1203f-7d63-401c-8d63-dc6be6d1a07b
	RealEstateU - ENT	2469e230-17e7-4249-9b83-6528afbe56bf
	RealEstateU - ENT	63534f46-af03-4690-85e8-57d94f839c4a
	RealEstateU - ENT	83fbd23e-2323-441a-9af7-509ad6f067ef
	RealEstateU - ENT	0e1f623a-0a49-4315-8f1f-8dc0010288ab
	RealEstateU - ENT	9a7773e7-0ac0-4e68-bcf1-91174e4b4295
	RealEstateU - ENT	f703dbec-6d86-44cb-b46b-425c834770f7
	RealEstateU - ENT	ccbdb136-f7c6-4d1e-8e9e-ac0efae71c46
	RealEstateU - ENT	e1a389ed-4ca4-44b5-980c-928d93c8a48a

LightRx

	LightRx - ENT	29c494a2-0aec-4e8c-9949-942bdaa86d19
	LightRx - ENT	ac13fb23-a5e3-4143-a3c9-4412ecdd3d63
	LightRx - ENT	9f37930f-6e42-4f8a-ac4b-cbdd36e2807d
	LightRx - ENT	d66a5919-e4cb-4848-a92e-9881d125b37d
	LightRx - ENT	e0f65b40-5526-40da-bece-6a7cef0010cb
	LightRx - ENT	5da912d4-0931-4850-8a0d-c63f7ed6112e
	LightRx - ENT	ce277d7f-0cb9-477a-8a38-5da882bc1b6f
	LightRx - ENT	327de201-b5cd-40a0-92c8-0d0bf7bca270
	LightRx - ENT	51343d2e-6ead-4f25-8167-92e60a6fd7bc
	LightRx - ENT	860057fa-5872-45dc-9d69-1a41847f8809
	LightRx - ENT	b65cd09b-2362-4ca5-b702-2862997dfb8f
	LightRx - ENT	5ace6c43-8c57-4041-bbb0-178081113ae2
	LightRx - ENT	268205d6-2786-4a4c-ad12-4a80fba2f961
	LightRx - ENT	69d3abb5-f6a2-4339-957c-4670af3b7bc8
	LightRx - ENT	8f32af7b-dd22-4ecd-b760-7840a4323008
	LightRx - ENT	8f618a97-7096-46d6-a1a9-5b5752de7846
	LightRx - ENT	4c3cbeaa-2a30-4895-9d2e-5eff5d9ab889
	LightRx - ENT	4f3bbd9c-6b87-4e7c-8f45-f14cbffb78fc
	LightRx - ENT	e5ba88a7-bfb1-4806-96af-15ce969e06aa
	LightRx - ENT	f12b16bc-5d0d-4e19-8f93-ec74e4430199
	LightRx - ENT	2f63c478-71a1-42b6-bcc3-e285871c54cc
	LightRx - ENT	34acff9d-5ee9-4e8f-aef8-b1cd3cbce2dc
	LightRx - ENT	31512681-06d2-45da-bf06-9ed037c63bce
	LightRx - ENT	c1fea627-f177-4820-9dbb-7ae6a07dc09d
	LightRx - ENT	fee28c1b-781c-4089-af12-1e0789f803a8



Homer Learning - COUP

'0948493a-55e5-4c0f-adec-356d6d629ded',
'25bff256-051f-480a-a75f-be7f46f55084',
'6b138c4c-ae7c-4491-935d-0dc69acc4c1e',
'eb5a5fca-c675-4a3f-a2e4-6e051fde42ca',
'187615ef-4086-4212-9d20-859276779165',
'5b4ea397-07f0-403b-a488-991e52342193',
'e3f6e597-f015-41bf-beb4-707f1584f4d1',


Byteme - COUP

'16a25d1b-4bf9-4bac-a9df-dfc3d89ab98f',
'08c2dd11-70b1-48b2-b864-f883d65f7dfe',
'6b94620b-3cd7-41d2-bd01-feaeed3f2463',
'c73e00a4-40c2-4d4b-b878-282b68359160',
'd32bb46e-135e-4626-a780-d69a2425ed65',
'6b97da7e-65a6-4bc7-92a8-020d77d03fe2',


BBQ Guys - COUP
'eac6376d-dd51-42fc-bef9-dae0eaf67ba3',
'17bbf08a-6e52-4f57-bfad-ac70823b6ef1'


Pirates Dinner Adventure

61509806-a623-43b4-a861-d2c5f7cdc050
18d7732a-59b5-4f21-ae5a-3a0583544f25
5d09a3d2-1224-49c4-8ab6-3b4a97bcafa3

(
'0948493a-55e5-4c0f-adec-356d6d629ded',
'25bff256-051f-480a-a75f-be7f46f55084',
'6b138c4c-ae7c-4491-935d-0dc69acc4c1e',
'eb5a5fca-c675-4a3f-a2e4-6e051fde42ca',
'187615ef-4086-4212-9d20-859276779165',
'5b4ea397-07f0-403b-a488-991e52342193',
'e3f6e597-f015-41bf-beb4-707f1584f4d1',
'16a25d1b-4bf9-4bac-a9df-dfc3d89ab98f',
'08c2dd11-70b1-48b2-b864-f883d65f7dfe',
'6b94620b-3cd7-41d2-bd01-feaeed3f2463',
'c73e00a4-40c2-4d4b-b878-282b68359160',
'd32bb46e-135e-4626-a780-d69a2425ed65',
'6b97da7e-65a6-4bc7-92a8-020d77d03fe2',
'eac6376d-dd51-42fc-bef9-dae0eaf67ba3',
'17bbf08a-6e52-4f57-bfad-ac70823b6ef1',
'61509806-a623-43b4-a861-d2c5f7cdc050',
'18d7732a-59b5-4f21-ae5a-3a0583544f25',
'5d09a3d2-1224-49c4-8ab6-3b4a97bcafa3'
)

------------------------------
drop table grp_gdoop_bizops_db.np_sl_min_deal;
create table grp_gdoop_bizops_db.np_sl_min_deal stored as orc as
select 
     done.*, 
     case when live_days_on_sl <= diff_btw_sl_min_groupon_min and live_days_on_sl < 30 then live_days_on_sl
          when diff_btw_sl_min_groupon_min <= live_days_on_sl and diff_btw_sl_min_groupon_min < 30 then diff_btw_sl_min_groupon_min
          else 30
          end number_of_days_comparison
from
(select 
     fin.*, 
     datediff(to_date(fin.max_live_date), to_date(fin.min_launch_date)) live_days_on_sl, 
     fin2.min_live_on_groupon, 
     datediff(to_date(fin.min_launch_date), to_date(fin2.min_live_on_groupon)) diff_btw_sl_min_groupon_min
from 
(select
     a.dealuuid,
     max(b.merchant_uuid) merchant_uuid,
     cast(min(eventdate) as date) min_launch_date, 
     cast(max(eventdate) as date) max_live_date
  from grp_gdoop_bizops_db.np_sl_all_deals as a
  left join grp_gdoop_bizops_db.pai_deals as b on a.dealuuid = b.deal_uuid
  group by a.dealuuid) as fin
left join 
(select deal_uuid, min(load_date) min_live_on_groupon from user_groupondw.active_deals group by deal_uuid) as fin2 on fin.dealuuid = fin2.deal_uuid
) as done
  ;
	

	
drop table grp_gdoop_bizops_db.np_case_study_pre1;
create table grp_gdoop_bizops_db.np_case_study_pre1 stored as orc as 
   select
      case when cl.aogcampaignid is not null then 'Sponsored' else 'Organic' end deal_landing,
      trim(lower(regexp_replace(search_query,'\\+',' '))) search_query,
      position,
      ogp,
      nor,
      nob,
      dv_time,
      bcookie,
      order_uuid,
      cl.dealuuid,
      clientplatform,
      aogcampaignid,
      '' extrainfo,
      case when rawpagetype = 'browse/deals/index' and fullurl like '%context=local%' or fullurl like '%category=%' then 'browse'
           when rawpagetype in ('browse/deals/index') and search_query is not null  and search_query!='' then 'search'
           when rawpagetype in ('homepage' ,'homepage/index', 'featured/deals/index') then 'homepage'
           when rawpagetype in ( 'browse/deals/index') then 'browse' --'featured'
           when rawpagetype in ('nearby/deals/index', --featured? or local only
                                 'goods/browse/index',
                                 'goods/index',
                                 'giftshop/deals/show',
                                 'giftshop/deals/index',
                                  'channels/show',
                                  'beautynow_promoted',
                                  'beautynow_salon',
                                  'beautynow_appointment_receipt',
                                  'beautynow_SELECT_appointment_time',
                                  'beautynow_SELECT_service') then 'browse'
           when rawpagetype like '%-%-%-%' then 'occasions'
           else rawpagetype
           end page,
        cl.eventdate
     from ai_reporting.sl_imp_clicks cl
     join (select dealuuid, min_launch_date
           from grp_gdoop_bizops_db.np_sl_min_deal
           ) dl on cl.dealuuid = dl.dealuuid
     where
        cast(cl.eventdate as date) < cast(dl.min_launch_date as date);
       


drop table grp_gdoop_bizops_db.np_case_study_pre2;
create table grp_gdoop_bizops_db.np_case_study_pre2 stored as orc as 
   select
          case when cl.aogcampaignid is not null then 'Sponsored' else 'Organic' end deal_landing,
          trim(lower(regexp_replace(search_query,'\\+',' '))) search_query,
          cast(cast(position as int )-1 as string) position ,
          ogp,
          nor,
          nob,
          dv_time,
          bcookie,
          order_uuid,
          cl.dealuuid,
          clientplatform,
          aogcampaignid,
          extrainfo,
          case when search_query is not null and search_query!='' and search_query!='All+Deals' then 'search'
               when (get_json_object(lower(extrainfo), '$.type' ) is null and get_json_object(extrainfo, '$.tabName' ) ='home_tab') then 'homepage' ---or channel='all'
               when rawpagetype in ('wolfhound_mobile_page', 'GlobalSearchResult', 'MapLedSearch') then 'browse'
               else 'other' end page,
          cl.eventdate
     from ai_reporting.sl_imp_clicks_app  cl
     join (select dealuuid, min_launch_date
           from grp_gdoop_bizops_db.np_sl_min_deal
           ) dl on cl.dealuuid = dl.dealuuid
     where
        cast(cl.eventdate as date) < cast(dl.min_launch_date as date);


       


       
drop table grp_gdoop_bizops_db.np_case_study_pre_all;
create table grp_gdoop_bizops_db.np_case_study_pre_all stored as orc as  
select 
       dealuuid,
       min_launch_date, 
       max_live_date,
       min_live_on_groupon,
       live_days_on_sl,
       number_of_days_comparison,
       deal_landing, 
       timeline,
       positions,
       sum(impressions) total_imps,
       sum(clicks) total_clicks,
       sum(merch_revenue) merch_revenue,
       sum(total_orders) total_orders
from 
(select 
     dl_sl.min_launch_date,
     dl_sl.max_live_date,
     dl_sl.live_days_on_sl,
     dl_sl.min_live_on_groupon, 
     dl_sl.number_of_days_comparison,
     dl_sl.diff_btw_sl_min_groupon_min,
     dl_sl.merchant_uuid,
     dl_sl.dealuuid,
     cast(fin.position as int) positions,
     fin.eventdate,
     fin.deal_landing,
     fin.timeline,
     count(1) impressions,
     count(distinct aogcampaignid) impressions_aog,
     count(distinct dv_time) clicks,
     count(distinct bcookie) distinct_users,
     sum(nob-nor) merch_revenue,
     count(distinct order_uuid) total_orders
from
grp_gdoop_bizops_db.np_sl_min_deal as dl_sl
left join 
(select a.*, 'pre' timeline
    from grp_gdoop_bizops_db.np_case_study_pre1 as a
         where cast(eventdate as date) >= cast('2020-01-01' as date)
     union all
  select a.*, 'pre' timeline
    from grp_gdoop_bizops_db.np_case_study_pre2 as a
          where cast(eventdate as date) >= cast('2020-01-01' as date)
 ) as fin on fin.dealuuid = dl_sl.dealuuid
group by 
     dl_sl.min_launch_date,
     dl_sl.max_live_date,
     dl_sl.live_days_on_sl,
     dl_sl.min_live_on_groupon, 
     dl_sl.number_of_days_comparison,
     dl_sl.diff_btw_sl_min_groupon_min,
     dl_sl.merchant_uuid,
     dl_sl.dealuuid,
     cast(fin.position as int),
     fin.eventdate,
     fin.deal_landing,
     fin.timeline) as fin 
where
     fin.positions <= 20 
     and 
     cast(eventdate as date) >= date_add(cast(min_launch_date as date), - number_of_days_comparison)
group by 
     dealuuid,
     min_launch_date, 
     max_live_date,
     min_live_on_groupon,
     live_days_on_sl,
     number_of_days_comparison,
     deal_landing, 
     timeline,
     positions
;
    

select * from grp_gdoop_bizops_db.np_case_study_pre_all where position is not null;

drop table grp_gdoop_bizops_db.np_temp_case_waster;
create table grp_gdoop_bizops_db.np_temp_case_waster stored as orc as
select deal_uuid, min(load_date) min_live_on_groupon 
from user_groupondw.active_deals group by deal_uuid


select a.*, 'pre' timeline
    from grp_gdoop_bizops_db.np_case_study_pre2 as a
          where cast(eventdate as date) >= cast('2020-01-01' as date)
                and cast(position as int) <= cast(20 as int);
               
               

               
               
               
drop table grp_gdoop_bizops_db.np_case_study_post_all;
create table grp_gdoop_bizops_db.np_case_study_post_all stored as orc as
select 
       dealuuid,
       min_launch_date, 
       max_live_date,
       min_live_on_groupon,
       live_days_on_sl,
       number_of_days_comparison,
       deal_landing, 
       timeline,
       positions,
       sum(impressions) total_imps,
       sum(clicks) total_clicks,
       sum(merch_revenue) merch_revenue,
       sum(total_orders) total_orders
from 
(select 
     dl_sl.min_launch_date,
     dl_sl.max_live_date,
     dl_sl.live_days_on_sl,
     dl_sl.min_live_on_groupon, 
     dl_sl.number_of_days_comparison,
     dl_sl.diff_btw_sl_min_groupon_min,
     dl_sl.merchant_uuid,
     dl_sl.dealuuid,
     cast(fin.position as int) positions,
     fin.eventdate,
     fin.deal_landing,
     fin.timeline,
     count(1) impressions,
     count(distinct aogcampaignid) impressions_aog,
     count(distinct dv_time) clicks,
     count(distinct bcookie) distinct_users,
     sum(nob-nor) merch_revenue,
     count(distinct order_uuid) total_orders
from
grp_gdoop_bizops_db.np_sl_min_deal as dl_sl
left join 
(select a.*, 'post' timeline
    from grp_gdoop_bizops_db.np_impressions_sl as a
  union all
  select a.*, 'post' timeline
    from grp_gdoop_bizops_db.np_impressions_sl_app as a 
 ) as fin on fin.dealuuid = dl_sl.dealuuid
group by 
   dl_sl.min_launch_date,
     dl_sl.max_live_date,
     dl_sl.live_days_on_sl,
     dl_sl.min_live_on_groupon, 
     dl_sl.number_of_days_comparison,
     dl_sl.diff_btw_sl_min_groupon_min,
     dl_sl.merchant_uuid,
     dl_sl.dealuuid,
     cast(fin.position as int),
     fin.eventdate,
     fin.deal_landing,
     fin.timeline) as fin 
     where fin.positions <= 20 
     and
     cast(eventdate as date) <= date_add(cast(min_launch_date as date), number_of_days_comparison)
group by 
     dealuuid,
     min_launch_date, 
     max_live_date,
     min_live_on_groupon,
     live_days_on_sl,
     number_of_days_comparison,
     deal_landing, 
     timeline,
     positions
;



    
drop table grp_gdoop_bizops_db.np_final_case;
create table grp_gdoop_bizops_db.np_final_case stored as orc as 
select 
       fin.dealuuid,
       b.deal_permalink, 
       c.merchant_uuid,
       d.merchant_name,
       fin.min_launch_date,
       fin.min_live_on_groupon,
       fin.live_days_on_sl,
       fin.number_of_days_comparison,
       fin.positions,
       sum(case when timeline = 'pre' then total_imps end)  total_imps_pre, 
       sum(case when timeline = 'post' and deal_landing = 'Organic' then total_imps end) total_imps_post_org, 
       sum(case when timeline = 'post' and deal_landing = 'Sponsored' then total_imps end) total_imps_post_sl,
       sum(case when timeline = 'pre' then total_clicks end)  total_clicks_pre, 
       sum(case when timeline = 'post' and deal_landing = 'Organic' then total_clicks end) total_clicks_post_org, 
       sum(case when timeline = 'post' and deal_landing = 'Sponsored' then total_clicks end) total_clicks_post_sl,
       sum(case when timeline = 'pre' then merch_revenue end)  merch_revenue_pre, 
       sum(case when timeline = 'post' and deal_landing = 'Organic' then merch_revenue end) merch_revenue_post_org, 
       sum(case when timeline = 'post' and deal_landing = 'Sponsored' then merch_revenue end) merch_revenue_post_sl,
       sum(case when timeline = 'pre' then total_orders end)  total_orders_pre, 
       sum(case when timeline = 'post' and deal_landing = 'Organic' then total_orders end) total_orders_post_org, 
       sum(case when timeline = 'post' and deal_landing = 'Sponsored' then total_orders end) total_orders_post_sl
from
(
select * from grp_gdoop_bizops_db.np_case_study_pre_all 
where dealuuid in 
                   (
'0948493a-55e5-4c0f-adec-356d6d629ded',
'25bff256-051f-480a-a75f-be7f46f55084',
'6b138c4c-ae7c-4491-935d-0dc69acc4c1e',
'eb5a5fca-c675-4a3f-a2e4-6e051fde42ca',
'187615ef-4086-4212-9d20-859276779165',
'5b4ea397-07f0-403b-a488-991e52342193',
'e3f6e597-f015-41bf-beb4-707f1584f4d1',
'16a25d1b-4bf9-4bac-a9df-dfc3d89ab98f',
'08c2dd11-70b1-48b2-b864-f883d65f7dfe',
'6b94620b-3cd7-41d2-bd01-feaeed3f2463',
'c73e00a4-40c2-4d4b-b878-282b68359160',
'd32bb46e-135e-4626-a780-d69a2425ed65',
'6b97da7e-65a6-4bc7-92a8-020d77d03fe2',
'eac6376d-dd51-42fc-bef9-dae0eaf67ba3',
'17bbf08a-6e52-4f57-bfad-ac70823b6ef1',
'61509806-a623-43b4-a861-d2c5f7cdc050',
'18d7732a-59b5-4f21-ae5a-3a0583544f25',
'5d09a3d2-1224-49c4-8ab6-3b4a97bcafa3'
)
union all 
select * from grp_gdoop_bizops_db.np_case_study_post_all
where dealuuid in 
(
'0948493a-55e5-4c0f-adec-356d6d629ded',
'25bff256-051f-480a-a75f-be7f46f55084',
'6b138c4c-ae7c-4491-935d-0dc69acc4c1e',
'eb5a5fca-c675-4a3f-a2e4-6e051fde42ca',
'187615ef-4086-4212-9d20-859276779165',
'5b4ea397-07f0-403b-a488-991e52342193',
'e3f6e597-f015-41bf-beb4-707f1584f4d1',
'16a25d1b-4bf9-4bac-a9df-dfc3d89ab98f',
'08c2dd11-70b1-48b2-b864-f883d65f7dfe',
'6b94620b-3cd7-41d2-bd01-feaeed3f2463',
'c73e00a4-40c2-4d4b-b878-282b68359160',
'd32bb46e-135e-4626-a780-d69a2425ed65',
'6b97da7e-65a6-4bc7-92a8-020d77d03fe2',
'eac6376d-dd51-42fc-bef9-dae0eaf67ba3',
'17bbf08a-6e52-4f57-bfad-ac70823b6ef1',
'61509806-a623-43b4-a861-d2c5f7cdc050',
'18d7732a-59b5-4f21-ae5a-3a0583544f25',
'5d09a3d2-1224-49c4-8ab6-3b4a97bcafa3'
)
) as fin
left join (select deal_id, max(deal_permalink) deal_permalink from user_edwprod.dim_gbl_deal_lob group by deal_id) as b on fin.dealuuid = b.deal_id
left join grp_gdoop_bizops_db.pai_deals as c on fin.dealuuid = c.deal_uuid
left join grp_gdoop_bizops_db.pai_merchants as d on c.merchant_uuid = d.merchant_uuid
group by 
    fin.dealuuid,
    b.deal_permalink,
    fin.min_launch_date,
    fin.min_live_on_groupon,
    fin.live_days_on_sl,
    fin.number_of_days_comparison,
    c.merchant_uuid,
    fin.positions,
    d.merchant_name;
    
    
drop table grp_gdoop_bizops_db.np_case_study_post_all2;
create table grp_gdoop_bizops_db.np_case_study_post_all2 stored as orc as
select 
       dealuuid,
       min_launch_date, 
       max_live_date,
       min_live_on_groupon,
       live_days_on_sl,
       number_of_days_comparison,
       eventdate,
       deal_landing, 
       timeline,
       positions,
       datediff(to_date(eventdate), to_date(min_launch_date)) days_from_launch, 
       datediff(to_date(CURRENT_DATE), to_date(eventdate)) days_from_current_date,
       sum(impressions) total_imps,
       sum(clicks) total_clicks,
       sum(merch_revenue) merch_revenue,
       sum(total_orders) total_orders
from 
(select 
     dl_sl.min_launch_date,
     dl_sl.max_live_date,
     dl_sl.live_days_on_sl,
     dl_sl.min_live_on_groupon, 
     dl_sl.number_of_days_comparison,
     dl_sl.diff_btw_sl_min_groupon_min,
     dl_sl.merchant_uuid,
     dl_sl.dealuuid,
     cast(fin.position as int) positions,
     fin.eventdate,
     fin.deal_landing,
     fin.timeline,
     count(1) impressions,
     count(distinct aogcampaignid) impressions_aog,
     count(distinct dv_time) clicks,
     count(distinct bcookie) distinct_users,
     sum(nob-nor) merch_revenue,
     count(distinct order_uuid) total_orders
from
grp_gdoop_bizops_db.np_sl_min_deal as dl_sl
left join 
(select a.*, 'post' timeline
    from grp_gdoop_bizops_db.np_impressions_sl as a
    where dealuuid in 
                   (
'0948493a-55e5-4c0f-adec-356d6d629ded',
'25bff256-051f-480a-a75f-be7f46f55084',
'6b138c4c-ae7c-4491-935d-0dc69acc4c1e',
'eb5a5fca-c675-4a3f-a2e4-6e051fde42ca',
'187615ef-4086-4212-9d20-859276779165',
'5b4ea397-07f0-403b-a488-991e52342193',
'e3f6e597-f015-41bf-beb4-707f1584f4d1',
'16a25d1b-4bf9-4bac-a9df-dfc3d89ab98f',
'08c2dd11-70b1-48b2-b864-f883d65f7dfe',
'6b94620b-3cd7-41d2-bd01-feaeed3f2463',
'c73e00a4-40c2-4d4b-b878-282b68359160',
'd32bb46e-135e-4626-a780-d69a2425ed65',
'6b97da7e-65a6-4bc7-92a8-020d77d03fe2',
'eac6376d-dd51-42fc-bef9-dae0eaf67ba3',
'17bbf08a-6e52-4f57-bfad-ac70823b6ef1',
'61509806-a623-43b4-a861-d2c5f7cdc050',
'18d7732a-59b5-4f21-ae5a-3a0583544f25',
'5d09a3d2-1224-49c4-8ab6-3b4a97bcafa3'
)
  union all
  select a.*, 'post' timeline
    from grp_gdoop_bizops_db.np_impressions_sl_app as a 
    where dealuuid in 
                   (
'0948493a-55e5-4c0f-adec-356d6d629ded',
'25bff256-051f-480a-a75f-be7f46f55084',
'6b138c4c-ae7c-4491-935d-0dc69acc4c1e',
'eb5a5fca-c675-4a3f-a2e4-6e051fde42ca',
'187615ef-4086-4212-9d20-859276779165',
'5b4ea397-07f0-403b-a488-991e52342193',
'e3f6e597-f015-41bf-beb4-707f1584f4d1',
'16a25d1b-4bf9-4bac-a9df-dfc3d89ab98f',
'08c2dd11-70b1-48b2-b864-f883d65f7dfe',
'6b94620b-3cd7-41d2-bd01-feaeed3f2463',
'c73e00a4-40c2-4d4b-b878-282b68359160',
'd32bb46e-135e-4626-a780-d69a2425ed65',
'6b97da7e-65a6-4bc7-92a8-020d77d03fe2',
'eac6376d-dd51-42fc-bef9-dae0eaf67ba3',
'17bbf08a-6e52-4f57-bfad-ac70823b6ef1',
'61509806-a623-43b4-a861-d2c5f7cdc050',
'18d7732a-59b5-4f21-ae5a-3a0583544f25',
'5d09a3d2-1224-49c4-8ab6-3b4a97bcafa3'
)
 ) as fin on fin.dealuuid = dl_sl.dealuuid
group by 
   dl_sl.min_launch_date,
     dl_sl.max_live_date,
     dl_sl.live_days_on_sl,
     dl_sl.min_live_on_groupon, 
     dl_sl.number_of_days_comparison,
     dl_sl.diff_btw_sl_min_groupon_min,
     dl_sl.merchant_uuid,
     dl_sl.dealuuid,
     cast(fin.position as int),
     fin.eventdate,
     fin.deal_landing,
     fin.timeline) as fin 
     where fin.positions <= 20 
group by 
     dealuuid,
     min_launch_date, 
     max_live_date,
     min_live_on_groupon,
     live_days_on_sl,
     number_of_days_comparison,
     deal_landing, 
     timeline,
     positions,
     eventdate,
     datediff(to_date(eventdate), to_date(min_launch_date)), 
       datediff(to_date(CURRENT_DATE), to_date(eventdate))
;


create table grp_gdoop_bizops_db.np_case_study_post_all_etc stored as orc as
select a.*, 
       datediff(to_date(eventdate), to_date(min_launch_date)) days_from_launch, 
       datediff(to_date(CURRENT_DATE), to_date(eventdate)) days_from_current_date
from grp_gdoop_bizops_db.np_case_study_post_all2 as a
where dealuuid in 
                   ('abe208b0-f79a-4ffc-b00a-c7ab3174531e', 'bc742c06-5082-41c9-9a1a-df57bd2e61d7', '01f70000-0bb9-4318-bbe4-79dd8a4c8d4f', 
                    '3fda84f3-f402-4bc1-ba45-4f945c286275', '1a226f06-1179-4e53-97ce-afd7b4fd29b1', '8aed4d2f-a7e6-4da0-9d10-2d6382684f6c', '02a76145-b2fd-457e-a3f7-4442af48e7a6',
                    '2ed9df69-c9dc-4f11-a832-784de84c9706', 'd444611b-6b9e-4bf6-811b-e704ce925179', '1c94819b-6c7e-4af5-b454-096cc9b5cfeb', 'cd0066d9-629d-49cb-be27-cc7555a74a9f', 
                    'eae26db7-5923-4835-8ca8-8e50e2dd3bbe','e3fd2c89-2371-4258-8e3d-708293bb81b5', '15cdcd5d-31c5-417a-9f42-95add368880c', 'ef45d110-8902-499d-8cca-987cef9009d2', 
                    'e7e35bf8-9fe3-4598-b322-4ad1e1a14c3a', 'bac147aa-b151-41cd-b834-3b1b759fb667', 'dcf354d7-9602-40e9-bc76-66f5cc7dc665', 
                    '3fa6b0d9-acd2-4c74-be9c-98d8e3515199', '6de3a148-11fe-4df1-a139-db5ad4a13764', 'cea19a48-754e-4e5c-868b-bad28a4a46ca',
                    '30d3b8ad-967c-4e8e-89b3-2f9d1ac04b26', 'ef8ccdfa-39a3-4038-a9f0-880dab993af1', 'd10d63d6-9602-4e3f-acd3-06d963d4b5e2', 'a42e3961-0a36-43cf-853b-fe86fd0cc68f',
                    'f09a2d2b-2820-4517-b19c-78e9f3cc26b4', 'a5f1942f-0c11-4785-93b8-e17a07baa831', '0ed03101-234d-4ad2-a2e7-d2c2b4595b9c', '9bce4f37-e274-48bc-8152-27e898ee4f24',
                    'bd876c5b-8be7-4f02-9a42-5e582aaa6ed0', '981fe8e0-145b-47d2-8919-8854132ac364', '2212684f-b331-44ca-8d18-fe524077ffd3', 'b5e20da9-21d5-40ff-b9b5-75a48de41b94',
                    'f5d6101b-5098-493e-af6f-a072f1951aa5', 'a85886ce-b722-4964-94d0-5f525d4b2b83', 'a1ac3718-0b56-47a1-a527-89256f4284e0', '1270f9a5-f249-4ff3-9a93-ed9c59be7bbf',
                    'e864e6f6-586c-4cf4-b90b-d8b4d63a348b', 'd7cd3ea3-398f-450a-ab55-779de378af08', 'b46e39ed-497b-4643-b7f4-d9886c7a6cec', '53196fcf-733a-46ca-af62-b5b21e67de6a',
                    '9d6c7545-c25f-4820-b0ba-437cf5bd4f91','fd81cba1-f10d-4f8b-a819-287ef51c8f71', 'dff1203f-7d63-401c-8d63-dc6be6d1a07b', '2469e230-17e7-4249-9b83-6528afbe56bf',
                    '63534f46-af03-4690-85e8-57d94f839c4a', '83fbd23e-2323-441a-9af7-509ad6f067ef', '0e1f623a-0a49-4315-8f1f-8dc0010288ab', '9a7773e7-0ac0-4e68-bcf1-91174e4b4295',
                    'f703dbec-6d86-44cb-b46b-425c834770f7', 'ccbdb136-f7c6-4d1e-8e9e-ac0efae71c46', 'e1a389ed-4ca4-44b5-980c-928d93c8a48a', '29c494a2-0aec-4e8c-9949-942bdaa86d19',
                    'ac13fb23-a5e3-4143-a3c9-4412ecdd3d63', '9f37930f-6e42-4f8a-ac4b-cbdd36e2807d', 'd66a5919-e4cb-4848-a92e-9881d125b37d', 'e0f65b40-5526-40da-bece-6a7cef0010cb',
                    '5da912d4-0931-4850-8a0d-c63f7ed6112e', 'ce277d7f-0cb9-477a-8a38-5da882bc1b6f', '327de201-b5cd-40a0-92c8-0d0bf7bca270', '51343d2e-6ead-4f25-8167-92e60a6fd7bc', 
                    '860057fa-5872-45dc-9d69-1a41847f8809', 'b65cd09b-2362-4ca5-b702-2862997dfb8f', '5ace6c43-8c57-4041-bbb0-178081113ae2', '268205d6-2786-4a4c-ad12-4a80fba2f961', 
                    '69d3abb5-f6a2-4339-957c-4670af3b7bc8', '8f32af7b-dd22-4ecd-b760-7840a4323008', '8f618a97-7096-46d6-a1a9-5b5752de7846', '4c3cbeaa-2a30-4895-9d2e-5eff5d9ab889', 
                    '4f3bbd9c-6b87-4e7c-8f45-f14cbffb78fc', 'e5ba88a7-bfb1-4806-96af-15ce969e06aa', 'f12b16bc-5d0d-4e19-8f93-ec74e4430199', '2f63c478-71a1-42b6-bcc3-e285871c54cc',
                    '34acff9d-5ee9-4e8f-aef8-b1cd3cbce2dc', '31512681-06d2-45da-bf06-9ed037c63bce', 'c1fea627-f177-4820-9dbb-7ae6a07dc09d', 'fee28c1b-781c-4089-af12-1e0789f803a8'
                    );

----------------------------

select 
       dealuuid,
       min_launch_date,
       min_live_on_groupon,
       live_days_on_sl,
       diff_btw_sl_min_groupon_min,
       sum(case when timeline = 'pre' then total_imps end)  total_imps_pre, 
       sum(case when timeline = 'post' and deal_landing = 'Organic' then total_imps end) total_imps_post_org, 
       sum(case when timeline = 'post' and deal_landing = 'Sponsored' then total_imps end) total_imps_post_sl,
       sum(case when timeline = 'pre' then total_clicks end)  total_clicks_pre, 
       sum(case when timeline = 'post' and deal_landing = 'Organic' then total_clicks end) total_clicks_post_org, 
       sum(case when timeline = 'post' and deal_landing = 'Sponsored' then total_clicks end) total_clicks_post_sl,
       sum(case when timeline = 'pre' then merch_revenue end)  merch_revenue_pre, 
       sum(case when timeline = 'post' and deal_landing = 'Organic' then merch_revenue end) merch_revenue_post_org, 
       sum(case when timeline = 'post' and deal_landing = 'Sponsored' then merch_revenue end) merch_revenue_post_sl,
       sum(case when timeline = 'pre' then total_orders end)  total_orders_pre, 
       sum(case when timeline = 'post' and deal_landing = 'Organic' then total_orders end) total_orders_post_org, 
       sum(case when timeline = 'post' and deal_landing = 'Sponsored' then total_orders end) total_orders_post_sl
from
(select
       dealuuid,
       eventdate,
       min_launch_date, 
       max_live_date,
       min_live_on_groupon,
       live_days_on_sl,
       diff_btw_sl_min_groupon_min,
       case when live_days_on_sl <= diff_btw_sl_min_groupon_min and live_days_on_sl < 30 then live_days_on_sl
          when diff_btw_sl_min_groupon_min <= live_days_on_sl and diff_btw_sl_min_groupon_min < 30 then diff_btw_sl_min_groupon_min
          else 30
          end number_of_days_comparison,
       deal_landing, 
       timeline,
       position,
       sum(impressions) total_imps,
       sum(clicks) total_clicks,
       sum(merch_revenue) merch_revenue,
       sum(total_orders) total_orders
from 
    grp_gdoop_bizops_db.np_sl_tab_perf_comp
where 
     cast(position as int) <= 20
group by 
     dealuuid, 
       eventdate, 
       min_launch_date, 
       max_live_date,
       min_live_on_groupon,
       live_days_on_sl,
       diff_btw_sl_min_groupon_min,
       case when live_days_on_sl <= diff_btw_sl_min_groupon_min and live_days_on_sl < 30 then live_days_on_sl
          when diff_btw_sl_min_groupon_min <= live_days_on_sl and diff_btw_sl_min_groupon_min < 30 then diff_btw_sl_min_groupon_min
          else 30
          end,
       deal_landing,  
       timeline, 
       position
) as fin
where
    cast(eventdate as date) <= date_add(cast(min_launch_date as date), number_of_days_comparison) 
and 
    cast(eventdate as date) >= date_add(cast(min_launch_date as date), - number_of_days_comparison)
group by 
    dealuuid,
       min_launch_date,
       min_live_on_groupon,
       live_days_on_sl,
       diff_btw_sl_min_groupon_min;